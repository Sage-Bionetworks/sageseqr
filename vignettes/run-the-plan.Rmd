---
title: "Run the drake plan"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Run the drake plan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

1. [Write your own config file](https://sage-bionetworks.github.io/sageseqr/articles/customize-config.html).

2. Specify the active configuration by setting `R_CONFIG_ACTIVE`.

```{r config-setup}
profile_set <- "default"
Sys.setenv(R_CONFIG_ACTIVE = profile_set)
```

3. Load the `sageseqr` library and login to [Synapse](https://www.synapse.org/). `rnaseq_plan()` calls the arguments from the config file and creates the `drake` plan. Execute `drake::make(plan)` to compute. Run this code from your project root.

```{r run-plan}
library(sageseqr)
# Login to Synapse. Make a Synapse account and use synapser to login: https://r-docs.synapse.org/articles/manageSynapseCredentials.html
synapser::synLogin()

# Run the analysis
replace_command <- paste('system( "sed ',
                         paste0('s/INSERT_CONFIG_PROFILE_HERE/',
                                profile_set,
                                "/g"
                                ),
                         " ../_targets_template.R > ../_targets.R\")",
                         sep = "'"
                        )

eval(parse( text=  
     glue::glue(replace_command)
 )
)

setwd('../')
targets::tar_manifest(fields="command")
targets::tar_glimpse()

#drake::make(
#  plan,
#  envir = getNamespace("sageseqr")
#    )
```

4. Visualize the results of your work. 

```{r visualize}
drake::vis_drake_graph(
  plan,
  envir = getNamespace("sageseqr"),
  targets_only = TRUE
  )
```